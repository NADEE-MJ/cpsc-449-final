<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search for Classes and Students</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <h1>Search</h1>
      <!-- Tab buttons to switch between student and class search -->
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="student-search-tab"
            data-bs-toggle="tab"
            href="#student-search"
            >Student Search</a
          >
        </li>
        <li class="nav-item">
          <a class="nav-link" id="class-search-tab" data-bs-toggle="tab" href="#class-search"
            >Class Search</a
          >
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content">
        <!-- Student Search Form -->
        <div class="tab-pane fade show active" id="student-search">
          <form id="studentSearchForm" class="mt-4">
            <div class="mb-3">
              <label for="email" class="form-label">Email:</label>
              <input type="email" id="email" name="email" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="full_name" class="form-label">Full Name:</label>
              <input type="text" id="full_name" name="full_name" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="grad_year" class="form-label">Graduation Year:</label>
              <input type="number" id="grad_year" name="grad_year" class="form-control" />
            </div>
            <!-- Repeated fields for class search as well -->
            <div class="mb-3">
              <label for="subject" class="form-label">Subject:</label>
              <input type="text" id="subject" name="subject" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="class_number" class="form-label">Class Number:</label>
              <input type="number" id="class_number" name="class_number" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="semester" class="form-label">Semester:</label>
              <input type="text" id="semester" name="semester" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="school_year" class="form-label">School Year:</label>
              <input type="number" id="school_year" name="school_year" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="professor" class="form-label">Professor:</label>
              <input type="text" id="professor" name="professor" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary">Search Students</button>
          </form>
        </div>

        <!-- Class Search Form -->
        <div class="tab-pane fade" id="class-search">
          <form id="classSearchForm" class="mt-4">
            <div class="mb-3">
              <label for="subject" class="form-label">Subject:</label>
              <input type="text" id="subject" name="subject" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="class_number" class="form-label">Class Number:</label>
              <input type="number" id="class_number" name="class_number" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="semester" class="form-label">Semester:</label>
              <input type="text" id="semester" name="semester" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="school_year" class="form-label">School Year:</label>
              <input type="number" id="school_year" name="school_year" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="professor" class="form-label">Professor:</label>
              <input type="text" id="professor" name="professor" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary">Search Classes</button>
          </form>
        </div>
      </div>

      <!-- Search Results List -->
      <ul id="results" class="list-group mt-4"></ul>
    </div>

    <!-- Scripts for handling tab switching and form submission -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.getElementById("studentSearchForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch("/student/search?" + new URLSearchParams(Object.fromEntries(formData)), {
          method: "GET",
          headers: { Authorization: `Bearer ${getCookie("token")}` },
        })
          .then((response) => response.json())
          .then((data) => displayResults(data, "students"))
          .catch((error) => console.log("Error:", error));
      });

      document.getElementById("classSearchForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch("/class/search?" + new URLSearchParams(Object.fromEntries(formData)), {
          method: "GET",
          headers: { Authorization: `Bearer ${getCookie("token")}` },
        })
          .then((response) => response.json())
          .then((data) => displayResults(data, "classes"))
          .catch((error) => console.log("Error:", error));
      });

      function getCookie(name) {
        const cookieString = document.cookie.split("; ").find((row) => row.startsWith(name));
        return cookieString ? cookieString.split("=")[1] : null;
      }

      function displayResults(data, type) {
        const resultsElement =
          type === "students"
            ? document.getElementById("studentResults")
            : document.getElementById("classResults");
        resultsElement.innerHTML = "";
        if (data[type] && data[type].length > 0) {
          data[type].forEach((item) => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            const link = document.createElement("a");
            link.href =
              type === "students" ? `/student/${item.id}/profile` : `/class/${item.id}/details`;
            link.textContent =
              type === "students"
                ? `${item.full_name} (${item.email})`
                : `${item.subject} ${item.class_number} - ${item.professor}`;
            li.appendChild(link);
            resultsElement.appendChild(li);
          });
        } else {
          resultsElement.innerHTML = `<li class="list-group-item">No results found.</li>`;
        }
      }
    </script>
  </body>
</html>
